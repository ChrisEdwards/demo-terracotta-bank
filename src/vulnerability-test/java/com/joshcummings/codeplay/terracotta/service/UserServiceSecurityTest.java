package com.joshcummings.codeplay.terracotta.service;

import com.joshcummings.codeplay.terracotta.AbstractEmbeddedTomcatTest;
import com.joshcummings.codeplay.terracotta.model.User;
import org.testng.annotations.Test;
import org.testng.Assert;

public class UserServiceSecurityTest extends AbstractEmbeddedTomcatTest {

    @Test
    public void testSqlInjectionMitigation() {
        // Arrange
        UserService userService = this.context.getBean(UserService.class);
        
        // Create a test user
        User testUser = new User("testuser_id", "testuser", "password123", "Test User", "test@example.com");
        userService.addUser(testUser);
        
        // Act - Attempt SQL injection in username parameter
        User foundUser = userService.findByUsernameAndPassword("testuser' OR '1'='1", "anything");
        
        // Assert - SQL injection attempt should fail to find a user
        Assert.assertNull(foundUser);
        
        // Clean up
        userService.removeUser("testuser");
    }
    
    @Test
    public void testLegitimateLogin() {
        // Arrange
        UserService userService = this.context.getBean(UserService.class);
        
        // Create a test user
        User testUser = new User("testuser2_id", "testuser2", "password123", "Test User 2", "test2@example.com");
        userService.addUser(testUser);
        
        // Act - Attempt legitimate login
        User foundUser = userService.findByUsernameAndPassword("testuser2", "password123");
        
        // Assert - Legitimate login should succeed
        Assert.assertNotNull(foundUser);
        Assert.assertEquals("testuser2", foundUser.getUsername());
        
        // Clean up
        userService.removeUser("testuser2");
    }
}